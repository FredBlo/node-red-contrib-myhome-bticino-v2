<script type="text/javascript">
  RED.nodes.registerType('myhome-commandsession',{
    category: 'Bticino MyHome',
    color: '#a6bbcf',
    defaults: {
      name: { value: '', required: true },
      gateway: { type: 'myhome-gateway', required: true },
      intercommandsdelay: { value: '', required: false, validate: function(v){return (v === '' || v === undefined || parseInt(v) >= 50)} }
    },
    inputs: 1,
    outputs: 1,
    icon: 'font-awesome/fa-terminal',
    paletteLabel: 'MH Inject',
    label: function() {
      return this.name || 'MH Inject';
    }
  });
</script>

<script type="text/x-red" data-template-name="myhome-commandsession">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Injector identifier" />
  </div>
  <div class="form-row">
      <label for="node-input-gateway"><i class="fa fa-server"></i> Gateway</label>
      <input type="text" id="node-input-gateway" />
  </div>
  <div class="form-row">
      <label for="node-input-intercommandsdelay"><i class="fa fa-history"></i> Delay (ms)</label>
      <input type="text" id="node-input-intercommandsdelay" placeholder="50 ms (minimum delay between 2 commands)"/>
      &nbsp;<i class="fa fa-info-circle" title="By default, a very limited delay (50ms) is applied before sending a new command to the MyHome gateway.
If you encounter some refused commands when processing multiple at once, you may decide to extend this delay to let the gateway 'breathe' a bit more."></i>
  </div>
</script>

<script type="text/x-red" data-help-name="myhome-commandsession">
  <p>MyHome Inject Node to send any supported OpenWebNet command to the MyHome system.</p>
    <ul>
      <li><strong>Name</strong> (mandatory) is the name of the node</li>
      <li><strong>Gateway</strong> is the gateway to be configured in order to connect to MyHome system</li>
      <li><strong>Delay (ms)</strong> is the custom delay to wait before sending a new command to the gateway</li>
    </ul>

  <h3>Inputs</h3>
    <p><code>msg.payload</code> must contain the command(s) to be sent, in OpenWebNet format (i.e. '*WHO*WHAT*WHERE##'). When multiple
commands have to be sent, this can be made by eeither using a string with commands set one after the other, or either using an array of strings).</p>

  <h3>Output</h3>
    <p>The <strong>output</strong> is a JSON object <code>msg.payload</code> with</p>
      <ul>
        <li> <code>payload.command_sent</code> <em>[array of string]</em> contains the commands which were sent in OpenWebNet protocol (e.g. <em>'*1*1*15##'</em> to turn on load 1.5)</li>
        <li> <code>payload.command_responses</code> <em>[array of strings]</em> will contain the returned response(s) from the MyHome BUS in OpenWebNet protocol</li>
      </ul>
    <p>Note: It will return an error when ALL commands have failed. As soon as at least 1 command was successful, no error is returned. </p>
</script>
