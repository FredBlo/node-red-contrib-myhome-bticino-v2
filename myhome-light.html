<script type="text/javascript">
  RED.nodes.registerType('myhome-light',{
    category: 'Bticino MyHome',
    color: '#a6bbcf',
    defaults: {
      name: { value: '', required: true },
      buslevel: { value: 'private_riser', required: false},
      lightid: { value: '', required: true, validate: RED.validators.number() },
      isgroup: { value: false, required: false},
      topic: { value: '', required: true},
      gateway: { type: 'myhome-gateway', required: true },
      smartfilter: { value: true, required: false},
      smartfilter_out: { value: true, required: false},
      skipevents: { value: false, required: false},
      isstatusrequest: { value: false, required: false},
      output2_name: { value: 'On', required: false},
      output2_type: { value: 'boolean', required: false}
    },
    inputs: 1,
    inputLabels: function () {
      return this._("common.input-label-simple") + ": 'ON / OFF / TOGGLE / UP / DOWN'";
    },
    outputs: 2,
    outputLabels: function (index) {
      if (index === 0) {
        return 'payload';
      } else if (index === 1) {
        let outputTypeDescr;
        if (this.output2_type === 'boolean') {
          outputTypeDescr = 'true/false';
        } else if (this.output2_type === 'text_state') {
          outputTypeDescr = 'ON/OFF';
        } else {
          outputTypeDescr = 'string';
        }
        return 'payload' + ((this.output2_name === '') ? '' : ('.' + this.output2_name)) + " = " + outputTypeDescr;
      }
    },
    icon: function() {
      if (this.isgroup) {
        return 'mh-lightbulb-group.svg';
      } else {
        return 'font-awesome/fa-lightbulb-o';
      }
    },
    paletteLabel: 'MH Light',
    label: function() {
      // Force default values for newly added fields (backward compatibility with prior releases : when never edited before, update/add new fields)
      // v2.2.1 Added BUS management
      if (this.buslevel === undefined) {this.buslevel = 'private_riser'}
      // v2.0.0 Added configurable secondary output
      if (this.output2_name === undefined) {this.output2_name = 'On'}
      if (this.output2_type === undefined) {this.output2_type = 'boolean'}
      // Return the label itself
      return this.name || 'MH Light';
    },
    oneditprepare: function() {
      let scope = this;
      $(document).off('change', '#node-input-topic');
      $(document).on('change', '#node-input-topic', function() {
        let topicName = $('#node-input-topic').val();
        let topicInfo = scope._('common.topic-info' , {'topicName': topicName});
        $('#node-info-topic').prop('title' , topicInfo);
      });

      $(document).off('click', '#label-for-smartfilter-options');
      $(document).on('click', '#label-for-smartfilter-options', function () {
        let toggleValue = $('#node-input-smartfilter').prop('checked');
        $('#node-input-smartfilter').prop('checked' , !toggleValue);
        $('#node-input-smartfilter_out').prop('checked' , !toggleValue);
      });

    }
  });
</script>

<script type="text/x-red" data-template-name="myhome-light">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.name"></span></label>
    <input type="text" id="node-input-name" data-i18n="[placeholder]mh-light.config.name-placeholder"/>
  </div>
  <div class="form-row">
    <label for="node-input-topic"><i class="fa fa-terminal"></i> <span data-i18n="common.topic"></span></label>
    <input type="text" id="node-input-topic" data-i18n="[placeholder]mh-light.config.topic-placeholder"/>
    &nbsp;<i id="node-info-topic" class="fa fa-info-circle" title=""></i>
  </div>
  <div class="form-row">
    <label for="node-input-gateway"><i class="fa fa-server"></i> <span data-i18n="common.gateway"></span></label>
    <input type="text" id="node-input-gateway"/>
  </div>

  <div style="border-top-style: solid ;border-width: 1px; border-color: #CCCCCC; height: 10px;"></div>

  <div class="form-row">
    <label for="node-input-lightid"><i class="fa fa-lightbulb-o"></i> <span data-i18n="mh-light.config.lightid"></span></label>
    <div style="display: inline-block; position: relative; width: 70%; height: 20px;">
      <select id="node-input-buslevel" style="width:110px">
        <option value="private_riser" data-i18n="common.riser-private"></option>
        <option value="01" data-i18n="common.riser-localbus-01">[Local bus 1]</option>
        <option value="02" data-i18n="common.riser-localbus-02">[Local bus 2]</option>
        <option value="03" data-i18n="common.riser-localbus-03">[Local bus 3]</option>
        <option value="04" data-i18n="common.riser-localbus-04">[Local bus 4]</option>
        <option value="05" data-i18n="common.riser-localbus-05">[Local bus 5]</option>
        <option value="06" data-i18n="common.riser-localbus-06">[Local bus 6]</option>
        <option value="07" data-i18n="common.riser-localbus-07">[Local bus 7]</option>
        <option value="08" data-i18n="common.riser-localbus-08">[Local bus 8]</option>
        <option value="09" data-i18n="common.riser-localbus-09">[Local bus 9]</option>
        <option value="10" data-i18n="common.riser-localbus-10">[Local bus 10]</option>
        <option value="11" data-i18n="common.riser-localbus-11">[Local bus 11]</option>
        <option value="12" data-i18n="common.riser-localbus-12">[Local bus 12]</option>
        <option value="13" data-i18n="common.riser-localbus-13">[Local bus 13]</option>
        <option value="14" data-i18n="common.riser-localbus-14">[Local bus 14]</option>
        <option value="15" data-i18n="common.riser-localbus-15">[Local bus 15]</option>
      </select>
      <div style="position: absolute; left: 114px; right: 0px; top:0px;">
        <input type="text" id="node-input-lightid" style="width:100%" data-i18n="[placeholder]mh-light.config.lightid-placeholder"/>
      </div>
    </div>
    <br>
    <div style="display: inline-block; position: relative; width: 100%; height: 20px;">
      <div style="position: absolute; left: 210px; right: 0px; top:3px;">
        <label for="node-input-isgroup" style="width:100%">
          <input type="checkbox" id="node-input-isgroup" style="display:inline-block; margin-left:10px; width:22px; vertical-align:baseline;"/><span data-i18n="mh-light.config.light-isgroup"></span>
        </label>
      </div>
    </div>
  </div>
  <div class="form-row">
    <label id="label-for-smartfilter-options"><i class="fa fa-filter"></i> <span data-i18n="common.option-smartfilter"></span></label>
    <label for="node-input-smartfilter" style="width:70%">
      <input type="checkbox" id="node-input-smartfilter" style="display:inline-block; margin-left:0px; width:22px; vertical-align:baseline;"/><span data-i18n="common.option-smartfilter-checkbox"></span>
      &nbsp;<i class="fa fa-info-circle" data-i18n="[title]common.option-smartfilter-info"></i>
    </label>
    <br>
    <label></label>
    <label for="node-input-smartfilter_out" style="width:70%">
      <input type="checkbox" id="node-input-smartfilter_out" style="display:inline-block; margin-left:0px; width:22px; vertical-align:baseline;"/><span data-i18n="common.option-smartfilter-out-checkbox"></span>
      &nbsp;<i class="fa fa-info-circle" data-i18n="[title]common.option-smartfilter-out-info"></i>
    </label>
  </div>
  <div class="form-row">
    <label for="node-input-skipevents"><i class="fa fa-ban"></i> <span data-i18n="common.option-skipevents"></span></label>
    <label for="node-input-skipevents" style="width:70%">
      <input type="checkbox" id="node-input-skipevents" style="display:inline-block; margin-left:0px; width:22px; vertical-align:baseline;"/><span data-i18n="common.option-skipevents-checkbox"></span>
      &nbsp;<i class="fa fa-info-circle" data-i18n="[title]common.option-skipevents-info"></i>
    </label>
  </div>
  <div class="form-row">
    <label for="node-input-isstatusrequest"><i class="fa fa-eye"></i> <span data-i18n="common.option-readonly"></span></label>
    <label for="node-input-isstatusrequest" style="width:70%">
      <input type="checkbox" id="node-input-isstatusrequest" style="display:inline-block; margin-left:0px; width:22px; vertical-align:baseline;"/><span data-i18n="common.option-readonly-checkbox"></span>
      &nbsp;<i class="fa fa-info-circle" data-i18n="[title]common.option-readonly-info"></i>
    </label>
  </div>

  <div class="form-tips form-row" style="background:#EFEFEF">
    <i class="fa fa-sign-out"></i> <b><span data-i18n="common.secondary-output-title"></span></b>
    <br>
    <span data-i18n="common.secondary-output-intro"></span>
    <br>
    <div class="form-row">
      <label for="node-input-output2_name" style="width:35%; margin-left:15px"><i class="fa fa-tags"></i> <span data-i18n="common.secondary-output-name"></span></label>
      <input type="text" id="node-input-output2_name" data-i18n="[placeholder]common.secondary-output-name-placeholder" style="width:55%"/>
      <label for="node-input-output2_name" style="width:15px">
        &nbsp;<i class="fa fa-info-circle" data-i18n="[title]common.secondary-output-name-info"></i>
      </label>
    </div>
    <div class="form-row">
      <label for="node-input-output2_type" style="width:35%; margin-left:15px"><i class="fa fa-check-square-o"></i> <span data-i18n="common.secondary-output-content"></span></label>
      <select id="node-input-output2_type" style="width:55%">
        <option value="boolean" data-i18n="mh-light.config.secondary-output-content-state-boolean">[.state (boolean: true / false)]</option>
        <option value="text_state" data-i18n="mh-light.config.secondary-output-content-state-txt">[.state (string: ON / OFF)]</option>
        <option value="brightness" data-i18n="mh-light.config.secondary-output-content-brightness">[.brightness (number: 20-100)]</option>
      </select>
    </div>
  </div>
</script>
