<script type="text/javascript">
  RED.nodes.registerType('myhome-scenario',{
    category: 'Bticino MyHome',
    color: '#a6bbcf',
    defaults: {
      name: { value: '', required: true },
      scenarioid: { value: '', required: true, validate: RED.validators.number() },
      scenariotype: { value: 'CEN+', required: true },
      topic: { value: '', required: true},
      gateway: { type: 'myhome-gateway', required: true },
      skipevents: { value: false, required: false },
      rules: {value:[{
        buttonFrom: 0,
        buttonTo: 31,
        onStartPress:false,
        onEndShortPress:true,
        onEndLongPress:true,
        onDuringLongPress:false,
        minLongPressDuration:1000
      }]},
      outputs: {value:1}
    },
    inputs: 1,
    outputs: 1,
    outputLabels: function(index) {
      let rule = this.rules[index-1];
      let label = '';
      if (rule) {
        if (rule.buttonFrom == rule.buttonTo) {
          label = 'button #' + rule.buttonFrom;
        } else {
          label = 'buttons #' + rule.buttonFrom + ' to #' + rule.buttonTo;
        }
        let onEvents = [];
        if (rule.onStartPress) {
          onEvents.push ('Start press');
        }
        if (rule.onEndShortPress) {
          onEvents.push ('Short press');
        }
        if (rule.onEndLongPress) {
          onEvents.push ('Long press');
        }
        if (rule.onDuringLongPress) {
          onEvents.push ('Long press (while pressed)');
        }
        if (onEvents.length) {
          label += ' on ' + onEvents.join (', ');
        }
      } else {
        label = 'Main payload';
      }
      return label;
    },
    icon: 'font-awesome/fa-magic',
    paletteLabel: 'MH Scenario',
    label: function() {
      return this.name || 'MH Scenario';
    },
    oneditprepare: function() {
      $(document).on('change', '#node-input-topic', function() {
        let infoVar = $('#node-input-topic').val();
        let infoMsg = "to trigger the action on this node, do not forget the incoming 'msg' MUST contain a 'msg.topic' which is either 'state/" + infoVar + "' (when used in read-only mode) "
        + "or 'cmd/" + infoVar + "' (when used in write mode), otherwise node will skip incoming message.";
        $('#node-info-topic').prop('title' , infoMsg);
      });

      // Styles used in rules container
      $("style").append("#node-input-rule-container .mhrule-fromtolabel {display:inline-block; width:100px; margin-left: 20px;}");
      $("style").append("#node-input-rule-container .mhrule-checkbox {display:inline-block; width:22px; margin-left:0px; vertical-align:baseline;}");
      $("style").append("#node-input-rule-container .mhrule-select {width:60px; height: 23px; padding: 2px 2px; margin-left: 25px; margin-right: 35px; text-align: center;}");
      $("style").append("#node-input-rule-container .mhrule-checkbox-label {width: auto; margin-bottom: 2px;}");

      $("#node-input-rule-container").css('min-height','300px').css('min-width','450px').editableList({
        addButton: 'add new buttons range',
        header: $("<div style='background:#EFEFEF; display:grid; grid-template-columns:135px 1fr 90px 30px'>"
            +"<div style='margin-left: 30px; display: inline-grid; margin-top: 5px; font-weight:bold'>Buttons range...</div>"
            +"<div style='display: inline-grid; margin-top: 5px; font-weight:bold'>Trigger a new flow on...</div>"
            +"<div style='display: inline-grid; justify-self: end; margin-top: 5px; font-weight:bold'>Output nÂ°</div>"
            +"</div>"),

        addItem: function (container, i, rules) {
          if (!rules.hasOwnProperty('rule')) {
            rules.rule = {};
          }
          var rule = rules.rule;
          // When object is new, apply default values
          if (!rule.hasOwnProperty('buttonFrom')) {
            rule.buttonFrom = '0';
          }
          if (!rule.hasOwnProperty('buttonTo')) {
            rule.buttonTo = '31';
          }
          if (!rule.hasOwnProperty('onEndShortPress')) {
            rule.onEndShortPress = true;
          }
          if (!rule.hasOwnProperty('onEndLongPress')) {
            rule.onEndLongPress = true;
          }
          if (!rule.hasOwnProperty('minLongPressDuration')) {
            rule.minLongPressDuration = 1000;
          }
          // ROW 1
          let row1 = $('<div/>').appendTo(container);
          row1.append('<span class="mhrule-fromtolabel">From...</span>');
          let field_onStartPress = $('<input/>',{id:"node-input-onStartPress_" + i,type:"checkbox", class:"mhrule-checkbox"}).appendTo(row1);
          row1.append('<label class="mhrule-checkbox-label" for="node-input-onStartPress_' + i + '">Start press</label>');
          // ROW1 : output info (rightest part)
          let finalspan = $('<span/>',{style:"float: right;margin-top: 6px;"}).appendTo(row1);
          finalspan.append('<i class="fa fa-sign-out"></i><span class="node-input-rule-index">'+(i+2)+'</span> ');
          // ROW 2
          let row2 = $('<div/>').appendTo(container);
          let field_buttonFrom = $('<select/>',{id:"node-input-buttonFrom_" + i, class:"mhrule-select"}).appendTo(row2);
          let field_onEndShortPress = $('<input/>',{id:"node-input-onEndShortPress_" + i, type:"checkbox", class:"mhrule-checkbox"}).appendTo(row2);
          row2.append('<label class="mhrule-checkbox-label" for="node-input-onEndShortPress_' + i + '">Short press (<0.5s)</label>');
          // ROW 3
          let row3 = $('<div/>').appendTo(container);
          row3.append('<span class="mhrule-fromtolabel">To...</span>');
          let field_onEndLongPress = $('<input/>',{id:"node-input-onEndLongPress_" + i, type:"checkbox", class:"mhrule-checkbox"}).appendTo(row3);
          row3.append('<label class="mhrule-checkbox-label" for="node-input-onEndLongPress_' + i + '" style="width:unset";>Long press when >&nbsp</label>');
          let field_minLongPressDuration = $('<input/>',{id:"node-input-minLongPressDuration_" + i, type:"text",style:"height:23px; width:55px; padding: 2px 2px;"}).appendTo(row3);
          row3.append('<label class="mhrule-checkbox-label" for="node-input-minLongPressDuration_' + i + '">&nbsp ms</label>');
          // ROW 4
          let row4 = $('<div/>').appendTo(container);
          let field_buttonTo = $('<select/>',{id:"node-input-buttonTo_" + i, class:"mhrule-select"}).appendTo(row4);
          let field_onDuringLongPress = $('<input/>',{id:"node-input-onDuringLongPress_" + i, type:"checkbox", class:"mhrule-checkbox"}).appendTo(row4);
          row4.append('<label class="mhrule-checkbox-label" for="node-input-onDuringLongPress_' + i + '">Long press (while pressed)</label>');

          // Build all 0-31 choices to both fields inputs
          for (let i = 0; i <= 31; i++) {
            field_buttonFrom.append($("<option></option>").val(i.toString()).text(i.toString()));
            field_buttonTo.append($("<option></option>").val(i.toString()).text(i.toString()));
          }

          // Events : When From & To selector is changed, ensure range remains OK
          field_buttonFrom.on ("change", function() {
            if (parseInt(field_buttonFrom.val()) > parseInt(field_buttonTo.val())) {
              field_buttonTo.val(field_buttonFrom.val());
            }
          });
          field_buttonTo.on ("change", function() {
            if (parseInt(field_buttonFrom.val()) > parseInt(field_buttonTo.val())) {
              field_buttonFrom.val(field_buttonTo.val());
            }
          });

          // Copy memory info back on fields
          field_buttonFrom.val (rule.buttonFrom.toString());
          field_buttonTo.val (rule.buttonTo.toString());
          field_minLongPressDuration.val (rule.minLongPressDuration.toString());
          // Checkboxes
          field_onStartPress.prop ('checked', rule.onStartPress);
          field_onEndShortPress.prop ('checked', rule.onEndShortPress);
          field_onEndLongPress.prop ('checked', rule.onEndLongPress);
          field_onDuringLongPress.prop ('checked', rule.onDuringLongPress);
          // Update total number of outputs (Primary is 1 + 1 per rule defined)
          $("#node-input-outputs").val(i+2);
        },
        removeItem: function (rule) {
          // Re-parse all remaining rules to re-number them in UI
          let rules = $("#node-input-rule-container").editableList('items');
          rules.each(function(i) {
            $(this).find(".node-input-rule-index").html(i+2);
          });
          // Update total number of outputs (Primary is 1 + 1 per rule defined)
          $("#node-input-outputs").val(rules.length+1);
        },
        sortItems: function (rules) {
          // Re-parse all remaining rules to re-number them in UI
          rules.each(function(i) {
            $(this).find(".node-input-rule-index").html(i+2);
          });
        },
        sortable: true,
        removable: true
      });

      // Add all previously saved rules back to UI List
      for (let i = 0 ; i < this.rules.length ; i++) {
        $("#node-input-rule-container").editableList('addItem',{rule:this.rules[i], i:i});
      }
    },

    oneditresize: function(size) {
        let rows = $("#dialog-form>div:not(.node-input-rule-container-row)");
        let height = size.height;
        for (let i = 0 ; i<rows.length ; i++) {
            height -= $(rows[i]).outerHeight(true);
        }
        let editorRow = $("#dialog-form>div.node-input-rule-container-row");
        height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
        height += 16;
        $("#node-input-rule-container").editableList('height',height);
    },

    oneditsave: function() {
      let rules = $("#node-input-rule-container").editableList('items');
      let node = this;
      node.rules = [];
      rules.each (function (i) {
        let rule = $(this);
        let savedRule = {};
        savedRule.buttonFrom = parseInt(rule.find("#node-input-buttonFrom_" + i).val());
        savedRule.buttonTo = parseInt(rule.find("#node-input-buttonTo_" + i).val());
        savedRule.onStartPress = rule.find("#node-input-onStartPress_" + i).prop("checked");
        savedRule.onEndShortPress = rule.find("#node-input-onEndShortPress_" + i).prop("checked");
        savedRule.onEndLongPress = rule.find("#node-input-onEndLongPress_" + i).prop("checked");
        savedRule.onDuringLongPress = rule.find("#node-input-onDuringLongPress_" + i).prop("checked");
        savedRule.minLongPressDuration = parseInt(rule.find("#node-input-minLongPressDuration_" + i).val());
        node.rules.push (savedRule);
      });
    }
  });
</script>

<script type="text/x-red" data-template-name="myhome-scenario">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Scenario name" />
  </div>
  <div class="form-row">
    <label for="node-input-scenarioid"><i class="fa fa-magic"></i> Scenario</label>
    <div style="display: inline-block; position: relative; width: 70%; height: 20px;">
      <select id="node-input-scenariotype" style="width:80px">
        <option value="CEN">CEN</option>
        <option value="CEN+">CEN+</option>
      </select>
      <div style="position: absolute; left: 85px; right: 0px; top:0px;">
        <input type="text" id="node-input-scenarioid" style="width:100%" placeholder="32 (for CEN 3.2) or 126 (for CEN+ 126)" />
      </div>
    </div>
  </div>
  <div class="form-row">
      <label for="node-input-topic"><i class="fa fa-terminal"></i> Topic</label>
      <input type="text" id="node-input-topic" placeholder="e.g. firstfloor-office" />
      &nbsp;<i id="node-info-topic" class="fa fa-info-circle" title=""></i>
  </div>
  <div class="form-row">
      <label for="node-input-gateway"><i class="fa fa-server"></i> Gateway</label>
      <input type="text" id="node-input-gateway" />
  </div>
  <div class="form-row">
      <label for="node-input-skipevents"><i class="fa fa-ban"></i> Skip events</label>
      <label for="node-input-skipevents" style="width:70%">
        <input type="checkbox" id="node-input-skipevents" style="display:inline-block; margin-left:0px; width:22px; vertical-align:baseline;" />Skip incoming events from gateway
        &nbsp;<i class="fa fa-info-circle" title="If necessary, all MyHome status updates received from the gateway about this node can be ignored, which means only Node-RED received payloads will be processed."></i>
      </label>
  </div>
  <div class="form-row">
    <i class="fa fa-sign-out"></i> <b>Additional outputs...</b>
  </div>
  <div class="form-row node-input-rule-container-row" style="width:100%">
    <input type="hidden" id="node-input-outputs"/>
    <ol id="node-input-rule-container"></ol>
  </div>
</script>



<script type="text/x-red" data-help-name="myhome-scenario">
<p>Adds a MyHome Scenario Node to your flow.</p>
</script>
