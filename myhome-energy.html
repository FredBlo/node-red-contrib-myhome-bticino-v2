<script type="text/javascript">
  RED.nodes.registerType('myhome-energy',{
    category: 'Bticino MyHome',
    color: '#a6bbcf',
    defaults: {
      name: { value: '', required: true },
      meterid: { value: '', required: true, validate: RED.validators.number() },
      metertype: { value: 'meter', required: true},
      meterscope: { value: 'instant', required: true},
      topic: { value: '', required: true},
      gateway: { type: 'myhome-gateway', required: true },
      smartfilter: { value: true, required: false},
      skipevents: { value: false, required: false},
      enablecache: { value: true, required: false},
      output2_name: { value: '', required: false},
      output2_type: { value: 'metered_Power', required: false}
    },
    inputs: 1,
    inputLabels: "simple mode: 'ON / OFF'",
    outputs: 2,
    outputLabels: function (index) {
      if (index === 0) {
        return 'payload';
      } else if (index === 1) {
        let outputTypeDescr;
        if (this.output2_type === 'metered_Power') {
          outputTypeDescr = '.metered_Power (number in ' + ((this.meterscope === 'instant') ? 'W' : 'Wh') + ')';
        } else if (this.output2_type === 'metered_Power_asText') {
          outputTypeDescr = '.metered_Power (text in ' + ((this.meterscope === 'instant') ? 'kW' : 'kWh') + ')';
        }
        return 'payload' + ((this.output2_name === '') ? '' : ('.' + this.output2_name)) + " = " + outputTypeDescr;
      }
    },
    icon: 'font-awesome/fa-bolt',
    paletteLabel: 'MH Energy',
    label: function() {
      // Return the label itself
      return this.name || 'MH Energy';
    },
    oneditprepare: function() {
      var node = this;
      $(document).on('change', '#node-input-topic', function() {
        let infoVar = $('#node-input-topic').val();
        let infoMsg = "to trigger the action on this node, do not forget the incoming 'msg' MUST contain a 'msg.topic' which is either 'state/" + infoVar + "'"
        + "or 'cmd/" + infoVar + "', otherwise node will skip incoming message. For energy node, there is no difference between 'state' or 'cmd', both will perform the same operations."
        $('#node-info-topic').prop('title' , infoMsg);
      });
      $(document).on('change', '#node-input-meterscope', function() {
        let curScope = $('#node-input-meterscope').val();
        let powerUnit = (curScope === 'instant') ? 'W' : 'Wh';
        $('#node-input-output2_type option[value="metered_Power"]').text('metered_Power (number in ' + powerUnit + ')');
        $('#node-input-output2_type option[value="metered_Power_asText"]').text('metered_Power (text in k' + powerUnit + ')');
      });
      $(document).on('click', '#node-myhome_energy-outputcache-button', function() {
        function doOutputLog(node, customMsg) {
          $.ajax({
              url: "inject/" + 'e61b02c6f22cc6cb',// node.id,
              type: "POST",
              data: JSON.stringify(customMsg||{}),
              contentType: "application/json; charset=utf-8",
              success: function (resp) {
                  alert ('Current cached content output to main output');
              },
              error: function (jqXHR, textStatus, errorThrown) {
                  alert ('Error outputting current cached content : ['+ errorThrown +'] ' + textStatus);
              }
          });
        }

        let msg = {'payload':'DEBUG_SENDCACHE'};
        doOutputLog(node , msg)
      });
    }
  });
</script>

<script type="text/x-red" data-template-name="myhome-energy">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Energy meter name" />
  </div>
  <div class="form-row">
      <label for="node-input-topic"><i class="fa fa-terminal"></i> Topic</label>
      <input type="text" id="node-input-topic" placeholder="e.g. solar-panels" />
      &nbsp;<i id="node-info-topic" class="fa fa-info-circle" title=""></i>
  </div>
  <div class="form-row">
      <label for="node-input-gateway"><i class="fa fa-server"></i> Gateway</label>
      <input type="text" id="node-input-gateway" />
  </div>
  <div style="border-top-style: solid ;border-width: 1px; border-color: #CCCCCC; height: 10px;"></div>
  <div class="form-row">
    <label for="node-input-meterid"><i class="fa fa-bolt"></i>&nbsp;&nbsp;Meter</label>
    <div style="display: inline-block; position: relative; width: 70%; height: 20px;">
      <select id="node-input-metertype" style="width:220px">
        <option value="meter">Power management meter</option>
        <option value="actuator">Power management actuator</option>
      </select>
      <div style="position: absolute; left: 228px; right: 0px; top:0px;">
        <input type="text" id="node-input-meterid" style="width:100%" placeholder="ID [1-255]" />
      </div>
    </div>
    &nbsp;<i class="fa fa-info-circle" title="Power meters devices are Bticino F520, F523, 3522 / Legrand 03555, 03557, 03554, while Power management actuators are Bticino F522, F523 / Legrand 03558, 03559."></i>
  </div>
  <div class="form-row">
      <label for="node-input-meterscope"><i class="fa fa-tachometer"></i> Scope</label>
      <select id="node-input-meterscope" style="width:70%">
        <option value="instant">Current power</option>
        <option value="day_uptonow">Daily consumption (today)</option>
        <option value="day">Daily consumption (time range)</option>
        <option value="hour">Hourly consumption (time range)</option>
        <option value="month_uptonow">Monthly consumption (current month)</option>
        <option value="month">Monthly consumption (time range)</option>
        <option value="sincebegin">Full consumption since begin</option>
      </select>
  </div>
  <div class="form-row">
    <label for="node-input-smartfilter"><i class="fa fa-filter"></i> SmartFilter</label>
    <label for="node-input-smartfilter" style="width:70%">
      <input type="checkbox" id="node-input-smartfilter" style="display:inline-block; margin-left:0px; width:22px; vertical-align:baseline;" />Enable 'Smart filtering' of gateway events
      &nbsp;<i class="fa fa-info-circle" title="SmartFilter is enabled by default, making the node only triggering a new flow (aka output) when a state CHANGED after a MyHome BUS message was received.
This is made to avoid multiple flows starting for the same info/command, because MyHome sends the same message multiple times (for status request, response,...)
&#13;
Note: SmartFilter is only applied for events received from the BUS (not the node-RED flows)"></i>
    </label>
  </div>
  <div class="form-row">
      <label for="node-input-skipevents"><i class="fa fa-ban"></i> Skip events</label>
      <label for="node-input-skipevents" style="width:70%">
        <input type="checkbox" id="node-input-skipevents" style="display:inline-block; margin-left:0px; width:22px; vertical-align:baseline;" />Skip incoming events from gateway
        &nbsp;<i class="fa fa-info-circle" title="If necessary, all MyHome status updates received from the gateway about this node can be ignored, which means only Node-RED received payloads will be processed."></i>
      </label>
  </div>
  <div class="form-row">
      <label for="node-input-enablecache"><i class="fa fa-retweet"></i> Use cache</label>
      <label for="node-input-enablecache" style="width:70%">
        <input type="checkbox" id="node-input-enablecache" style="display:inline-block; margin-left:0px; width:22px; vertical-align:baseline;" />Cache previously fetched results
        &nbsp;<i class="fa fa-info-circle" title="By default, the node will keep all previously fetched results in memory. When the same scope is asked, cached content is used instead of firing (many) requests on the MyHome BUS. Cache is non persistent and reset on node re-deploy and node-RED restart.
&#13;
!! The cache is also useful (/required) for some commands (such as daily consumtpion) and / or when working with gateways which do not provide response to calls as they should... but the node can still fetch info directly on the BUS and cache it instead...
&#13;
Note that, regardless of this setting, cache is never used for partial results (i.e. instant power, today, current month,...) since content will keep changing from call to call."></i>
      </label>
      <button type="button" class="red-ui-button red-ui-button-small" style="margin-top: 4px; margin-right: unset; float: right;" id="node-myhome_energy-outputcache-button">
        <span> inject now</span>
      </button>
  </div>
  <div class="form-tips form-row" style="background:#EFEFEF">
    <i class="fa fa-sign-out"></i> <b>Secondary output options</b>
    <br>
    You may fine-tune the secondary output to better suit your needs when integrating with other node mechanisms (see node help for more info).
    <br>
    <div class="form-row">
      <label for="node-input-output2_name" style="width:35%; margin-left:15px"><i class="fa fa-tags"></i> Property name</label>
      <input type="text" id="node-input-output2_name" placeholder="e.g. Power / state / ... / (empty)" style="width:55%" />
      <label for="node-input-output2_name" style="width:15px">
        &nbsp;<i class="fa fa-info-circle" title="Is the property name on the returned payload (i.e. payload.propertyname). When left empty, the payload is returned as a single value (i.e. not as an object)"></i>
      </label>
    </div>
    <div class="form-row">
      <label for="node-input-output2_type" style="width:35%; margin-left:15px"><i class="fa fa-check-square-o"></i> Data type</label>
      <select id="node-input-output2_type" style="width:55%">
        <option value="metered_Power">.metered_Power (number in W)</option>
        <option value="metered_Power_asText">.metered_Power (text in kW)</option>
      </select>
    </div>
  </div>
</script>

<script type="text/x-red" data-help-name="myhome-energy">
<p>Adds a MyHome Energy management Node to your flow.</p>
  <ul>
    <li><strong>Name</strong> (mandatory) is the name of the node</li>
    <li><strong>Topic</strong> is used on received payload to trigger the action on the node (see info in inputs definition)</li>
    <li><strong>Gateway</strong> is the gateway to be configured in order to connect to MyHome system</li>
    <li><strong>Meter</strong> is the type and address (1 to 255) of the meter in MyHome system :</li>
      <ul>
        <li><strong>Power management meter</strong> are, according to OpenWebNet documentation, Bticino F520, F523, 3522 / Legrand 03555, 03557, 03554</li>
        <li><strong>Power management actuators</strong> are, according to OpenWebNet documentation, Bticino F522, F523 / Legrand 03558, 03559</li>
      </ul>
    <li><strong>Scope</strong> allows to define which mode of the meter is to be used for this node :</li>
      <ul>
        <li><strong>Current power</strong> : returns the 'real-time' consumption, in Watts</li>
        <li><strong>Daily consumption (today)</strong> : returns the consumption (Wh) since begin of the day (@00:00:00 AM)</li>
        <li><strong>Daily consumption (time range)</strong> : returns the consumption (Wh), for a time range specified in input (see below), detailled per day*.</li>
        <li><strong>Hourly consumption (time range)</strong> : returns the consumption (Wh), for a time range specified in input (see below), detailled per hour*.</li>
        <li><strong>Monthly consumption (current month)</strong> : returns the consumption (Wh) since begin of the month (1st day @00:00:00 AM)</li>
        <li><strong>Monthly consumption (time range)</strong> : returns the consumption (Wh), for a time range specified in input (see below), detailled per month**.</li>
        <li><strong>Full consumption since begin</strong> : returns the consumption (Wh), since meter was last reset.</li>
        <i>* meters store daily/hourly details for 12 months (i.e. current month and 11 months before), asking for info outside this range will result in range being limited when possible, or return a null range (when both From and To date are outside of this range).</i>
        <br><i>** meters store monthly details for 12 years.</i>
      </ul>
    <li><strong>Enable 'Smart filtering' of gateway events</strong> : when enabled, the node only triggers a new flow (aka output) when a state CHANGED after a MyHome BUS message was received. This is made to avoid multiple flows starting for the same info/command, because MyHome sends the same message multiple times (for status request, response,...)
      <br>Note: SmartFilter is only applied for events received from the BUS (not the node-RED flows)
    </li>
    <li><strong>Skip incoming events from gateway</strong> : when enabled, all MyHome status updates received from the gateway about this node will be ignored, which means only Node-RED received payloads will be processed.</li>
    <li><strong>Cache previously fetched results</strong> : by default, the node will keep all previously fetched results in memory. When the same scope is asked, cached content is used instead of firing (many) requests on the MyHome BUS. Cache is non persistent and reset on node re-deploy and node-RED restart.
      <br>!! The cache is also useful (/required) for some commands (such as daily consumtpion) and / or when working with gateways which do not provide response to calls as they should... but the node can still fetch info directly on the BUS and cache it instead...
      <br>Note that, regardless of this setting, cache is never used for partial results (i.e. instant power, today, current month,...) since content will keep changing from call to call.
    </li>
  </ul>

<h3>Inputs</h3>
  <p><code>msg.payload</code> can be of 2 types</p>
    <ul>
      <li>... anything</li>
      When node is configured in 'Current power', 'Daily consumption (today)', 'Monthly consumption (current month)' or 'Full consumption since begin', no parameter is necessary. The node will always gather info from the BUS and return value(s) as configured.
      </li>
      <li>An Object
        <ul>
          <li> <code>payload.metered_From</code> <em>[string]</em> value must be convertible to a valid date (+time); if not defaults to current date-time.
            <br>Defines from when meter info must be collected</li>
          <li> <code>payload.metered_To</code> <em>[string]</em> value must be convertible to a valid date (+time); if not defaults to <code>payload.metered_From</code>.
            <br>Defines until when meter info must be collected</li>
        </ul>
      </li>
    </ul>
  <p><code>msg.topic</code> is <strong>required</strong> to trigger the node action: received <code>msg.topic</code> must be set to <code>cmd/xxxx</code> or <code>state/xxxx</code>where xxxx is the value defined as Topic in node configuration. For energy managemetn nodes, there is no different behaviour between 'cmd' or 'state' modes.</p>

<h3>Outputs</h3>
  <p>The <strong>primary output</strong> is a JSON object <code>msg.payload</code> with</p>
    <ul>
      <li> <code>payload.metered_Scope</code> <em>[string]</em> the node's configured scope (can be : 'instant', 'day_uptonow', 'day', 'hour', 'month_uptonow', 'month', 'sincebegin')</li>
      <li> <code>payload.metered_From</code> <em>[string (date-time)]</em> the effective date since which the data was collected on the meter</li>
      <li> <code>payload.metered_To</code> <em>[string (date-time)]</em> the effective date up to which the data was collected on the meter</li>
      <li> <code>payload.metered_Power</code> <em>[number]</em> the instant power (W) or the total consumption (Wh) metered during the provided date-time range</li>
      <li> <code>payload.metered_Power_asText</code> <em>[string]</em> the power value converted to a 'readable' text (i.e. 900 -> 900Wh, 1250 -> 1,25kWh, 1543134 -> 1,54MWh)</li>
      <li> <code>payload.metered_Info</code> <em>[array of objects]</em> an object is returned for each metered interval (hour / day / month) with, as content :
        <ul>
          <li> <code>.metered_From</code> <em>[string (date-time)]</em> the effective date since which this data interval was collected on the meter</li>
          <li> <code>.metered_To</code> <em>[string (date-time)]</em> the effective date up to which this data interval was collected on the meter</li>
          <li> <code>payload.metered_Power</code> <em>[number]</em> the power consumption (Wh) metered during the provided date-time range</li>
          <li> <code>payload.metered_Frame</code> <em>[string]</em> -technical- the OpenWebNet frame which was received form the BUS and was analyzed for this data interval</li>
          <li> <code>payload.metered_CacheID</code> <em>[boolean]</em> -technical internal use for cache management- is the cache 'unique key'</li>
          <li> <code>payload.metered_CacheIsStatic</code> <em>[boolean]</em> -technical internal use for cache management- indicates this data interval will not evolve anymore in the future</li>
        </ul>
      </li>
      <li> <code>payload.command_sent</code> <em>[array of string]</em> when the node was triggered from Node-RED (i.e. commands were sent to the MyHome gateway), contains the commands which were sent in OpenWebNet protocol</li>
      <li> <code>payload.command_received</code> <em>[string]</em> when the node was triggered from the gateway (i.e. a command was detected on the MyHome BUS for the configured load), contains the command which was read in OpenWebNet protocol</li>
      <li> <code>payload.command_responses</code> <em>[array of strings]</em> when the node was triggered from Node-RED, will contain the returned response(s) from the MyHome BUS in OpenWebNet protocol</li>
      <li> <code>payload.command_failed</code> <em>[array of strings]</em> will contain the commands which were refused by the MyHome gateway, in OpenWebNet protocol</li>
    </ul>

  <p>The <strong>secondary output</strong> can be configured to better suits the needs of other node types you use without having to use an extra function/switch node for each connector.</p>
</script>
